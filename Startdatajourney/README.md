# Apache Airflow 2.2: практический курс

Прохождение [практического курса](https://startdatajourney.com/ru/course/apache-airflow-2) по основам Apache Airflow

Веб-интерфейс Airflow поднимается на http://127.0.0.1:8080
> Пользователь: admin
пароль: admin

## Web-интерфейс
Сразу после входа в панель Airflow можно увидеть список всех DAG-ов. Интерфейс включает: 

- Pause/Unpause DAG — слева находится переключатель для включения/выключения DAG. По умолчанию все новые DAG будут остановлены. Чтобы запустить DAG его необходимо предварительно включить.
- Колонка Owner обозначает владельца/автора DAG. Эта опция задаётся в коде, позже мы поговорим об атрибутах DAG, создавая свой первый пайлайн.
- Runs — показывает состояние запусков прошлых DAG. Есть 3 состояния:
    + Успешно выполнен
    +  Выполняется
    + Есть ошибки при выполнении
- Schedule — показывает с какой периодичностью будет запускаться DAG. Если значение None, то запуска по расписанию не будет, но можно запускать вручную, например.
- Last Run — дата и время последнего запуска DAG
- Recent Tasks — отражает текущее состояние последних запусков DAG (по факту последний запуск DAG и его операторов)
- Actions — кнопки манипуляции с DAG. Можно запустить DAG вручную, обновить или удалить DAG.
- Links — список для быстрого доступа к просмотру кода DAG, деталей выполнения, просмотру в виде графа или диаграммы Ганта, анализ времени выполнения задач и т.д.

### Просмотр DAG
Если кликнуть на любой DAG, то можно посмотреть детальную информацию по нему.

- Tree View — просмотр DAG и зависимостей между операторами в виде дерева, также справа находится статус выполнения всех операторов, входящих в DAG с легендой. На статусы можно кликать, чтобы посмотреть более детальную информацию.
- Graph View — фактически то же самое, что и Tree View, только в виде графа.
- Task Duration — график времени выполнения DAG и операторов.
- Task Tries — показывает график повторных запусков операторов по периодам.
- Landing Times — график показывает время (в зависимости от периодичности, это могут быть дни, минуты и т.д. по оси Y) прошедшее относительно периода запуска и непосредственным запуском (DagRun) планировщиком. *Представьте что есть DAG с schedule_interval=@daily запуск с execution_date=2020-01-01 должен быть запланирован на 2020-01-02T00:00:00, но планировщик из-за нагрузки запускает его в 2020-01-02T11:00:00, тогда Landing Time для него будет 11 часов или 0.46 дней.*
- Gantt — отображает историю выполнения DAG в виде Диаграммы Ганта. Очень удобно, когда в DAG входит множество операторов, которые могут выполняться параллельно.
- Details — детальная информация по DAG, включая названия операторов, автора, начальное время старта DAG и т.д.
- Code — просмотр кода DAG.


## Настройки Airflow
Записаны и могут быть изменены в файле ```~/airflow/airflow.cfg```

Все DAG расположены в папке 

dags_folder = /home/irina/airflow/dags


## Курсы валют 

1. Поднимаем Postgresql:
```bash
docker run -d -p 15432:5432 \
-e POSTGRES_PASSWORD=password \
-e POSTGRES_USER=airflow_user \
-e POSTGRES_DB=airflow_examples \
-v postgres_airflow_example:/var/lib/postgresql/data postgres:13.1
```

2. Изменяем БД по умолчанию на:
```bash
# Variable: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
#
sql_alchemy_conn = postgresql+psycopg2://airflow_user:password@localhost:15432/airflow_examples
```

3. Установливаем провайдер PostgreSQL
```bash
pip install apache-airflow-providers-postgres
```